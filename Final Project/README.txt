This code is a mess. Please don't look at it. 